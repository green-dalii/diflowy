---
import MainLayout from "../layouts/MainLayout.astro";
import SectionTitle from "../components/ui/SectionTitle.astro";
import Section from "../components/sections/Section.astro";
import "../styles/globals.css";
const description = "In User Center you can manage your Dify workflows.";
---

<MainLayout
  title="Blog | Diflowy"
  description="Where Dify workflows are stored"
>
  <div class="mt-48">
    <Section>
      <SectionTitle sectionTitle="User Center" description={description} />
      <div class="sm:grid sm:grid-cols-6 mt-40">
        <div id="not-login" class="sm:col-start-3 sm:col-span-2 text-center">
          <p class="text-sm mb-5">
            Please Login before entering the User Center.
          </p>
          <a id="login-link" href="/login"
            ><button class="btn-tertiary w-full xl:w-auto py-2" id="login"
              >üîê Login</button
            >
          </a>
        </div>
      </div>
      <div id="protected-content" style="display: none;">
        <table class="table table-auto">
          <thead>
            <tr>
              <th>No.</th>
              <th>Workflow Name</th>
              <th>Latest Version</th>
              <th>Manage</th>
            </tr>
          </thead>
          <tbody id="workflowTable">
            <tr>
            </tr>
          </tbody>
        </table>
        <div class="mt-14 text-center">
          <div class="join" id="pagination"></div>
        </div>
      </div>
    </Section>
  </div>
</MainLayout>

<script>
  import { updatePagination, fetchWorkflows } from "../utils/tools";
  import type { Workflow, GetWorkflowsResponse } from "../utils/tools";
  const workflowTableBody = document.getElementById("workflowTable") as HTMLTableSectionElement;
  // Get the modal element
  const modal = document.getElementById("modal") as HTMLDialogElement;
  const modalTitle = document.getElementById(
    "modalTitle",
  ) as HTMLHeadingElement;
  const modalContent = document.getElementById(
    "modalContent",
  ) as HTMLDivElement;
  
  function updateUserWorkflowsTable(workflowsResponse: GetWorkflowsResponse) {
    workflowTableBody.innerHTML = "";
    const workflows = workflowsResponse.workflows as Workflow[];
    const page = workflowsResponse.page as number;
    const pageSize = workflowsResponse.pageSize as number;
    workflows.forEach((workflow: Workflow, index: number) => {
      const row = document.createElement("tr");
      row.id = `${workflow.id}`;
      row.innerHTML = `
        <td>${index + 1 + pageSize * (page - 1)}</td>
        <td>${workflow.name}</td>
        <td>${workflow.latestVersion}</td>
        <td>
          <a href="/workflow/${workflow.id}">
            <button class="btn-primary">
              üìù Manage
            </button>
          </a>
        </td>
      `;
      workflowTableBody.appendChild(row);
    });
  }

  async function loadPageData(page: number =1) {
    try{
      const workflowsResponse = await fetchWorkflows(page, 10, undefined, "yes");
      updateUserWorkflowsTable(workflowsResponse);
      updatePagination(workflowsResponse.total, workflowsResponse.page, workflowsResponse.pageSize, loadPageData);
    }catch(error){
      console.error("Error loading page data:", error);
      modalTitle.innerText = "‚ö†Ô∏è Error";
      modalContent.innerText =
        "Failed to fetch workflows. Please check your connection and try again.";
      modal.showModal();
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadPageData(1);
  });
</script>

